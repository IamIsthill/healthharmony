{% extends 'base.html' %}
{% load static %}
{% load tags %}
{% block title %}Dashboard | HealthHarmony{% endblock %}
{% block header %}
    <link rel="stylesheet" href="{% static 'css/modern-normalize.css' %}" />
    <link rel="stylesheet" href="{% static 'css/clinic/nav.css' %}" />
    <link rel="stylesheet" href="{% static 'css/admin/dashboard.css' %}" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    <link rel="stylesheet" href="{% static 'css/utils.css' %}" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp"
          rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
          rel="stylesheet" />
{% endblock %}
{% block message %}
    {% if messages|has_error_message %}
        {% comment %} {% include 'error.html' %} {% endcomment %}
        <div class="containerPage js-error-modal" id="popupError">
            <div class="popUp-visit">
                <svg xmlns="http://www.w3.org/2000/svg"
                     height="70px"
                     viewBox="0 -960 960 960"
                     width="70px"
                     fill="#FF2D19">
                    <path d="M479.98-280q14.02 0 23.52-9.48t9.5-23.5q0-14.02-9.48-23.52t-23.5-9.5q-14.02 0-23.52 9.48t-9.5 23.5q0 14.02 9.48 23.52t23.5 9.5ZM453-433h60v-253h-60v253Zm27.27 353q-82.74 0-155.5-31.5Q252-143 197.5-197.5t-86-127.34Q80-397.68 80-480.5t31.5-155.66Q143-709 197.5-763t127.34-85.5Q397.68-880 480.5-880t155.66 31.5Q709-817 763-763t85.5 127Q880-563 880-480.27q0 82.74-31.5 155.5Q817-252 763-197.68q-54 54.31-127 86Q563-80 480.27-80Zm.23-60Q622-140 721-239.5t99-241Q820-622 721.19-721T480-820q-141 0-240.5 98.81T140-480q0 141 99.5 240.5t241 99.5Zm-.5-340Z" />
                </svg>
                <span>Unexpected Error</span>
                {% for message in messages %}
                    {% if message.tags == 'error' %}<p>{{ message }}</p>{% endif %}
                {% endfor %}
                <button class="js-modal-btn-ok">OK</button>
            </div>
        </div>
    {% endif %}
    {% if messages|has_success_message %}
        <div class="containerPage js-success-modal" id="popupSuccess">
            <div class="popUp-visit js-modal-content">
                <svg xmlns="http://www.w3.org/2000/svg"
                     height="70px"
                     viewBox="0 -960 960 960"
                     width="70px"
                     fill="#2FC32C">
                    <path d="m421-298 283-283-46-45-237 237-120-120-45 45 165 166Zm59 218q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-156t86-127Q252-817 325-848.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 82-31.5 155T763-197.5q-54 54.5-127 86T480-80Zm0-60q142 0 241-99.5T820-480q0-142-99-241t-241-99q-141 0-240.5 99T140-480q0 141 99.5 240.5T480-140Zm0-340Z" />
                </svg>
                <span>Success!</span>
                {% for message in messages %}
                    {% if message.tags == 'success' %}<p>{{ message }}</p>{% endif %}
                {% endfor %}
                <button class="btn js-modal-btn-ok">OK</button>
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block main %}
    <div class="admin-container">
        {% include 'doctor/nav-top.html' %}
        {% include 'administrator/nav.html' %}
        <main>
            <div class="small-card">
                <h2>Active User</h2>
                <h3>{{ count_users }}</h3>
            </div>
            <div class="Chart user-chart">
                <div class="top-chart">
                    <h3>User Reports</h3>
                    <div class="date-buttons">
                        <button class="user-filter-btn" data-category="year">12 Months</button>
                        <button class="user-filter-btn" data-category="month">30 Days</button>
                        <button class="user-filter-btn" data-category="week">7 Days</button>
                    </div>
                </div>
                <div class="canvas-size">
                    <canvas id="user-canvas"></canvas>
                </div>
            </div>
            <div class="lower">
                <div class="account-roles">
                    <h3>Account Roles</h3>
                    <div>
                        <div>
                            <canvas id="account-roles"></canvas>
                        </div>
                    </div>
                </div>
                <div class="Chart demo-chart">
                    <h3>User Demographics</h3>
                    <div class="canvas-size">
                        <canvas id="user-demo"></canvas>
                    </div>
                </div>
            </div>
        </main>
    </div>
{% endblock %}
{% block script %}
    <script src="{% static 'js/general/messages.js' %}" type="module"></script>
    <script src="{% static 'chart.js/dist/chart.umd.js' %}"></script>
    <script>
    // Get the desired filter
    let userDateFilter = 'year'
    const userFilterBtns = document.querySelectorAll('.user-filter-btn')
    userFilterBtns.forEach((btn) => {
      btn.addEventListener('click', () => {
        let text = btn.getAttribute('data-category').toLowerCase()
        userDateFilter = text
        fetchUserData()
      })
    })
    //====================================================

    // A function to fetch user data from database
    async function fetchUserData() {
      try {
        const baseUrl = window.location.origin
        let url = new URL(baseUrl + '/api/administrator/user-data/')
        const params = { date_filter: userDateFilter }

        // Append parameters to URL
        Object.keys(params).forEach((key) => url.searchParams.append(key, params[key]))

        const response = await fetch(url)
        const data = await response.json()
        let ar = data[userDateFilter]

        createUserReport(ar)
      } catch (error) {
        console.error('There has been a problem with your fetch operation:', error)
      }
    }

    fetchUserData()

    //====================================================

    // A function to fetch account role data from database
    async function fetchAccountRoleData() {
      try {
        const baseUrl = window.location.origin
        let url = new URL(baseUrl + '/api/administrator/account-role-data/')

        const response = await fetch(url)
        const data = await response.json()
        createAccountRoles(data)
      } catch (error) {
        console.error('There has been a problem with your fetch operation:', error)
      }
    }

    fetchAccountRoleData()

    //====================================================

    // A function to fetch user demographics data from database
    async function fetchUserDemographicsData() {
      try {
        const baseUrl = window.location.origin
        let url = new URL(baseUrl + '/api/administrator/user-demographics-data/')

        const response = await fetch(url)
        const data = await response.json()
        createUserDemopgraphics(data)
      } catch (error) {
        console.error('There has been a problem with your fetch operation:', error)
      }
    }

    fetchUserDemographicsData()

    //====================================================

    // Create the user Reports

    function createUserReport(data) {
      const userCanvas = document.getElementById('user-canvas')

      let labels = []
      let datasets = []

      Object.entries(data).forEach(([key, value]) => {
        labels.push(key)
        datasets.push(value)
      })

      let ctx = userCanvas.getContext('2d')
      let existingChart = Chart.getChart(ctx)
      if (existingChart) {
        existingChart.destroy() // Destroy if it exists
      }
      window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              data: datasets,
              backgroundColor: 'rgba(204, 144, 0, 1)',
              borderColor: 'rgba(255, 99, 132, 1)',
              borderWidth: 1,
              tension: 0.5
            }
          ]
        },
        options: {
          scales: {
            x: {
              stacked: true
            },
            y: {
              beginAtZero: false,
              stacked: true,
              min: 0
            }
          },
          responsive: true,
          plugins: {
            legend: {
              display: false // This will hide the legend
            },
            backgroundGradient: {
              // Custom plugin to apply gradient
              beforeRender: function (chart, args, options) {
                const chartArea = chart.chartArea
                if (chartArea) {
                  const gradient = getGradient(chart.ctx, chartArea)
                  chart.data.datasets.forEach((dataset) => {
                    dataset.backgroundColor = gradient
                  })
                }
              }
            }
          }
        }
      })
    }
    //====================================================

    //Function to create account roles
    function createAccountRoles(data) {
      const accountRolesCanvas = document.getElementById('account-roles')
      let labels = []
      let datasets = []

      Object.entries(data).forEach(([key, value]) => {
        labels.push(key)
        datasets.push(value)
      })

      let ctx = accountRolesCanvas.getContext('2d')
      let existingChart = Chart.getChart(ctx)
      if (existingChart) {
        existingChart.destroy() // Destroy if it exists
      }
      window.myChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [
            {
              data: datasets,
              backgroundColor: ['rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)'],
              hoverOffset: 4,
              borderWidth: 1
            }
          ]
        },
        options: {
          scales: {
            x: {
              stacked: true,
              display: false
            },
            y: {
              beginAtZero: false,
              stacked: true,
              min: 0,
              display: false
            }
          },
          responsive: true,
          plugins: {
            backgroundGradient: {
              // Custom plugin to apply gradient
              beforeRender: function (chart, args, options) {
                const chartArea = chart.chartArea
                if (chartArea) {
                  const gradient = getGradient(chart.ctx, chartArea)
                  chart.data.datasets.forEach((dataset) => {
                    dataset.backgroundColor = gradient
                  })
                }
              }
            }
          }
        }
      })
    }
    //====================================================

    //Function to create user demographics graph
    function createUserDemopgraphics(data) {
      const userDemoCanvas = document.getElementById('user-demo')
      let labels = []
      let datasets = []

      data.forEach((d) => {
        labels.push(d.department)
        datasets.push(d.user_count)
      })

      let ctx = userDemoCanvas.getContext('2d')
      let existingChart = Chart.getChart(ctx)
      if (existingChart) {
        existingChart.destroy() // Destroy if it exists
      }
      window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              labels: labels,
              data: datasets,
              backgroundColor: ['rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(255, 205, 86)'],
              hoverOffset: 4,
              borderWidth: 1
            }
          ]
        },
        options: {
          scales: {
            x: {
              stacked: true
            },
            y: {
              beginAtZero: false,
              stacked: true,
              min: 0
            }
          },
          responsive: true,
          plugins: {
            legend: {
              display: false
            },
            backgroundGradient: {
              // Custom plugin to apply gradient
              beforeRender: function (chart, args, options) {
                const chartArea = chart.chartArea
                if (chartArea) {
                  const gradient = getGradient(chart.ctx, chartArea)
                  chart.data.datasets.forEach((dataset) => {
                    dataset.backgroundColor = gradient
                  })
                }
              }
            }
          }
        }
      })
    }
    //====================================================
    </script>
    <script>
    function resizeCanvas(canvasId, containerClass) {
      const canvas = document.getElementById(canvasId)
      const container = document.querySelector(containerClass)
      canvas.width = container.clientWidth
      canvas.height = container.clientHeight
    }

    // Resize the user-canvas
    function resizeUserCanvas() {
      resizeCanvas('user-canvas', '.canvas-size')
    }

    // Resize the user-demo canvas
    function resizeUserDemoCanvas() {
      resizeCanvas('user-demo', '.demo-chart .canvas-size')
    }

    // Add event listeners for resizing
    window.addEventListener('resize', () => {
      resizeUserCanvas()
      resizeUserDemoCanvas()
    })

    // Call the functions initially to set the canvas sizes
    resizeUserCanvas()
    resizeUserDemoCanvas()
    </script>
{% endblock %}
