{% extends 'base.html' %}
{% load static %}
{% load tags %}
{% block title %}Log and Records | HealthHarmony{% endblock %}
{% block header %}{% endblock %}
{% block message %}
    {% if messages|has_error_message %}
        {% comment %} {% include 'error.html' %} {% endcomment %}
        <div class="containerPage js-error-modal" id="popupError">
            <div class="popUp-visit">
                <svg xmlns="http://www.w3.org/2000/svg"
                     height="70px"
                     viewBox="0 -960 960 960"
                     width="70px"
                     fill="#FF2D19">
                    <path d="M479.98-280q14.02 0 23.52-9.48t9.5-23.5q0-14.02-9.48-23.52t-23.5-9.5q-14.02 0-23.52 9.48t-9.5 23.5q0 14.02 9.48 23.52t23.5 9.5ZM453-433h60v-253h-60v253Zm27.27 353q-82.74 0-155.5-31.5Q252-143 197.5-197.5t-86-127.34Q80-397.68 80-480.5t31.5-155.66Q143-709 197.5-763t127.34-85.5Q397.68-880 480.5-880t155.66 31.5Q709-817 763-763t85.5 127Q880-563 880-480.27q0 82.74-31.5 155.5Q817-252 763-197.68q-54 54.31-127 86Q563-80 480.27-80Zm.23-60Q622-140 721-239.5t99-241Q820-622 721.19-721T480-820q-141 0-240.5 98.81T140-480q0 141 99.5 240.5t241 99.5Zm-.5-340Z" />
                </svg>
                <span>Unexpected Error</span>
                {% for message in messages %}
                    {% if message.tags == 'error' %}<p>{{ message }}</p>{% endif %}
                {% endfor %}
                <button class="js-modal-btn-ok">OK</button>
            </div>
        </div>
    {% endif %}
    {% if messages|has_success_message %}
        <div class="containerPage js-success-modal" id="popupSuccess">
            <div class="popUp-visit js-modal-content">
                <svg xmlns="http://www.w3.org/2000/svg"
                     height="70px"
                     viewBox="0 -960 960 960"
                     width="70px"
                     fill="#2FC32C">
                    <path d="m421-298 283-283-46-45-237 237-120-120-45 45 165 166Zm59 218q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-156t86-127Q252-817 325-848.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 82-31.5 155T763-197.5q-54 54.5-127 86T480-80Zm0-60q142 0 241-99.5T820-480q0-142-99-241t-241-99q-141 0-240.5 99T140-480q0 141 99.5 240.5T480-140Zm0-340Z" />
                </svg>
                <span>Success!</span>
                {% for message in messages %}
                    {% if message.tags == 'success' %}<p>{{ message }}</p>{% endif %}
                {% endfor %}
                <button class="btn js-modal-btn-ok">OK</button>
            </div>
        </div>
    {% endif %}
{% endblock %}
{% block main %}
    <div class="container">
        {% include 'administrator/nav.html' %}
        <div class="upper">
            <h3>User Activity Trail</h3>
            <table>
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Timestamp</th>
                        <th>Action</th>
                        <th>Access</th>
                    </tr>
                </thead>
                <tbody>
                    {% if logs %}
                        {% for log in logs %}
                            <tr>
                                <td>{{ log.user }}</td>
                                <td>{{ log.timestamp }}</td>
                                <td>{{ log.action }}</td>
                                <td>
                                    {% if log.user.access == 1 %}
                                        Patient
                                    {% elif log.user.access == 2 %}
                                        Clinic Staff
                                    {% elif log.user.access == 3 %}
                                        Doctor
                                    {% else %}
                                        Admin
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td cols="4">No Data Available</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
            <div class="pagination pagination-design">
                <span class="step-links">
                    {% if logs.has_previous %}
                        <a href="?logs_page=1" class="js-links">&laquo; First</a>
                        <a class="js-links" href="?logs_page={{ logs.previous_page_number }}">Previous</a>
                    {% endif %}
                    <span class="current">Page {{ logs.number }} of {{ logs.paginator.num_pages }}.</span>
                    {% if logs.has_next %}
                        <a class="js-links" href="?logs_page={{ logs.next_page_number }}">Next</a>
                        <a class="js-links" href="?logs_page={{ logs.paginator.num_pages }}">Last &raquo;</a>
                    {% endif %}
                </span>
            </div>
        </div>
        <div class="lower">
            <h3>Data Change Trail</h3>
            <table>
                <thead>
                    <tr>
                        <th>Table</th>
                        <th>Related Id</th>
                        <th>Action</th>
                        <th>Old Value</th>
                        <th>New Value</th>
                        <th>Changed By</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% if data_logs %}
                        {% for log in data_logs %}
                            <tr>
                                <td>{{ log.table }}</td>
                                <td>{{ log.record_id }}</td>
                                <td>{{ log.action }}</td>
                                <td>
                                    {% if log.old_value == 'No data' %}
                                        <em>No Data</em>
                                    {% else %}
                                        {{ log.old_value }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if log.new_value == 'No data' %}
                                        <em>No Data</em>
                                    {% else %}
                                        {{ log.new_value }}
                                    {% endif %}
                                </td>
                                <td>{{ log.changed_by }}</td>
                                <td>{{ log.timestamp|date:'F j, Y' }} at {{ log.timestamp|date:'g:i A' }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td cols="6">No data available</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
            <div class="pagination pagination-design">
                <span class="step-links">
                    {% if data_logs.has_previous %}
                        <a href="?data_page=1" class="js-links">&laquo; First</a>
                        <a class="js-links"
                           href="?data_page={{ data_logs.previous_page_number }}">Previous</a>
                    {% endif %}
                    <span class="current">Page {{ data_logs.number }} of {{ data_logs.paginator.num_pages }}.</span>
                    {% if data_logs.has_next %}
                        <a class="js-links" href="?data_page={{ data_logs.next_page_number }}">Next</a>
                        <a class="js-links"
                           href="?data_page={{ data_logs.paginator.num_pages }}">Last &raquo;</a>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script src="{% static 'js/general/messages.js' %}" type="module"></script>
    <script src="{% static 'js/administrator/records.js' %}" type="module"></script>
{% endblock %}
